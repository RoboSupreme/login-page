<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Class View</title>
  <link rel="stylesheet" href="style.css" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Poppins', sans-serif;
    }
    
    body {
      min-height: 100vh;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      line-height: 1.6;
      margin: 0;
      padding: 20px;
      color: #2d3748;
      display: flex;
      justify-content: center;
      align-items: flex-start;
    }
    
    .container {
      position: relative;
      z-index: 1;
      max-width: 1200px;
      margin: 20px auto;
      padding: 30px;
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(5px);
      border-radius: 15px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      padding-bottom: 15px;
      border-bottom: 1px solid rgba(0, 0, 0, 0.1);
    }
    
    .class-info {
      background-color: rgba(255, 255, 255, 0.9);
      border-radius: 10px;
      padding: 25px;
      margin-bottom: 30px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      transition: all 0.3s ease;
    }
    
    .class-info:hover {
      transform: translateY(-5px);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    }
    
    .class-code {
      display: inline-block;
      background-color: #e3f2fd;
      padding: 8px 15px;
      border-radius: 8px;
      font-size: 0.9rem;
      margin-top: 15px;
      font-weight: 500;
      color: #2196F3;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }
    
    .tabs {
      display: flex;
      margin-bottom: 30px;
      background-color: rgba(255, 255, 255, 0.8);
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    
    .tab {
      padding: 15px 25px;
      cursor: pointer;
      background-color: rgba(240, 240, 240, 0.7);
      transition: all 0.3s ease;
      flex: 1;
      text-align: center;
      font-weight: 500;
      color: #4a5568;
    }
    
    .tab.active {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
    }
    
    .tab:hover:not(.active) {
      background-color: rgba(224, 224, 224, 0.9);
      transform: translateY(-2px);
    }
    
    .tab-content {
      display: none;
      padding: 25px;
      background-color: rgba(255, 255, 255, 0.9);
      border-radius: 10px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      transition: all 0.3s ease;
    }
    
    .tab-content.active {
      display: block;
    }
    
    .button {
      padding: 12px 20px;
      border: none;
      border-radius: 10px;
      color: white;
      cursor: pointer;
      font-size: 16px;
      font-weight: 500;
      background: #667eea;
      transition: all 0.3s ease;
    }
    
    .button:hover {
      background: #764ba2;
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
    }
    
    .back-btn {
      background-color: #757575;
    }
    
    .back-btn:hover {
      background-color: #616161;
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
    }
    
    .add-btn {
      background-color: #4CAF50;
    }
    
    .add-btn:hover {
      background-color: #3e8e41;
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
    }
    
    .admin-btn {
      background-color: #ff9800;
    }
    
    .admin-btn:hover {
      background-color: #e68a00;
    }
    
    .member-list {
      list-style: none;
      padding: 0;
    }
    
    .member-item {
      padding: 10px 15px;
      border-bottom: 1px solid #eee;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    
    .member-item:last-child {
      border-bottom: none;
    }
    
    .member-role {
      background-color: #e3f2fd;
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 0.8rem;
    }
    
    .member-role.admin {
      background-color: #ffcc80;
    }
    
    .journal-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 20px;
    }
    
    .journal-card {
      background-color: #fff;
      border-radius: 8px;
      padding: 15px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      transition: transform 0.2s, box-shadow 0.2s;
    }
    
    .journal-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    
    .journal-title {
      margin-top: 0;
      color: #2196F3;
    }
    
    .journal-meta {
      display: flex;
      justify-content: space-between;
      margin-top: 15px;
      font-size: 0.8rem;
      color: #757575;
    }
    
    .admin-controls {
      margin-top: 20px;
      padding-top: 20px;
      border-top: 1px dashed #ccc;
      display: none; /* Hidden by default, shown for admins */
    }
    
    .empty-state {
      text-align: center;
      padding: 40px;
      color: #757575;
      font-style: italic;
    }
    
    /* Modal styles */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }
    
    .modal.active {
      display: flex;
    }
    
    .modal-content {
      background-color: #fff;
      border-radius: 8px;
      width: 90%;
      max-width: 600px;
      max-height: 90vh;
      overflow-y: auto;
      padding: 20px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.2);
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 1px solid #eee;
    }
    
    .modal-header h2 {
      margin: 0;
    }
    
    .close-btn {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: #666;
    }
    
    .modal-footer {
      margin-top: 20px;
      padding-top: 15px;
      border-top: 1px solid #eee;
      display: flex;
      justify-content: flex-end;
      gap: 10px;
    }
    
    .form-group {
      margin-bottom: 15px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: 500;
    }
    
    .form-group input, .form-group textarea {
      width: 100%;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 16px;
    }
    
    .form-group textarea {
      min-height: 100px;
      resize: vertical;
    }
    
    .error-text {
      color: #d32f2f;
      font-size: 14px;
      margin-top: 5px;
      display: none;
    }
    
    .save-btn {
      background-color: #4CAF50;
    }
    
    .cancel-btn {
      background-color: #f5f5f5;
      color: #333;
    }
    
    /* Member roles styling */
    .role-badge {
      display: inline-block;
      padding: 3px 8px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 500;
    }
    
    .role-badge.admin {
      background-color: #ff9800;
      color: white;
    }
    
    .role-badge.teacher {
      background-color: #4CAF50;
      color: white;
    }
    
    .role-badge.student {
      background-color: #2196F3;
      color: white;
    }
    
    /* Journal styling */
    .journal-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 20px;
    }
    
    .journal-card {
      background-color: #fff;
      border-radius: 8px;
      padding: 15px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      transition: transform 0.2s, box-shadow 0.2s;
      cursor: pointer;
      border-left: 5px solid #2196F3;
    }
    
    .journal-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }
    
    .journal-title {
      margin-top: 0;
      margin-bottom: 10px;
      color: #333;
    }
    
    .journal-meta {
      display: flex;
      justify-content: space-between;
      font-size: 0.8rem;
      color: #666;
      margin-top: 15px;
      padding-top: 10px;
      border-top: 1px solid #eee;
    }
    
    .preview-text {
      font-size: 0.9rem;
      color: #555;
      margin: 10px 0;
      line-height: 1.4;
      overflow: hidden;
      text-overflow: ellipsis;
      display: -webkit-box;
      -webkit-line-clamp: 3;
      line-clamp: 3;
      -webkit-box-orient: vertical;
    }
    
    /* Background slider styles */
    .background-slider {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: -1;
      overflow: hidden;
    }
    
    .slider-img {
      position: absolute;
      height: 100%;
      width: auto;
      opacity: 0;
      transition: opacity 0.5s ease;
    }
    
    .slide-left {
      animation: slideLeft 10s linear;
    }
    
    .slide-right {
      animation: slideRight 10s linear;
    }
    
    .slide-top {
      animation: slideTop 10s linear;
    }
    
    .slide-bottom {
      animation: slideBottom 10s linear;
    }
    
    @keyframes slideLeft {
      0% {
        opacity: 0;
        transform: translateX(-100%);
      }
      5% {
        opacity: 0.3;
      }
      95% {
        opacity: 0.3;
      }
      100% {
        opacity: 0;
        transform: translateX(100%);
      }
    }
    
    @keyframes slideRight {
      0% {
        opacity: 0;
        transform: translateX(100%);
      }
      5% {
        opacity: 0.3;
      }
      95% {
        opacity: 0.3;
      }
      100% {
        opacity: 0;
        transform: translateX(-100%);
      }
    }
    
    @keyframes slideTop {
      0% {
        opacity: 0;
        transform: translateY(-100%);
      }
      5% {
        opacity: 0.3;
      }
      95% {
        opacity: 0.3;
      }
      100% {
        opacity: 0;
        transform: translateY(100%);
      }
    }
    
    @keyframes slideBottom {
      0% {
        opacity: 0;
        transform: translateY(100%);
      }
      5% {
        opacity: 0.3;
      }
      95% {
        opacity: 0.3;
      }
      100% {
        opacity: 0;
        transform: translateY(-100%);
      }
    }
    
    /* Header styles */
    h1 {
      color: #2d3748;
      margin-bottom: 20px;
      font-size: 2.2em;
      font-weight: 600;
    }
    
    h2 {
      color: #4a5568;
      margin-bottom: 20px;
      font-size: 1.5em;
      font-weight: 500;
    }
    
    h3 {
      color: #2d3748;
      font-weight: 500;
      margin-bottom: 15px;
    }
  </style>
</head>
<body>
  <div class="background-slider">
    <img src="https://mms.magloft.com/Rm1hCOb8sG8Wrikp/1zoJojJNyF1E5MIK?optimizer=image&width=1536" alt="HKIS Image 1" class="slider-img">
    <img src="https://mms.magloft.com/Rm1hCOb8sG8Wrikp/z1YVNy0F7IhP5kmv?optimizer=image&width=1536" alt="HKIS Image 2" class="slider-img">
    <img src="https://mms.magloft.com/Rm1hCOb8sG8Wrikp/OUXtie6rUc4St9ea?optimizer=image&width=1536" alt="HKIS Image 3" class="slider-img">
  </div>
  <div class="container">
    <div class="header">
      <h1 id="className">Class Name</h1>
      <div>
        <button id="backBtn" class="button back-btn">Back to Dashboard</button>
      </div>
    </div>
    
    <div class="class-info">
      <p id="classDescription">Loading class information...</p>
      <div id="classCode" class="class-code">Code: </div>
      <p id="createdBy">Created by: </p>
    </div>
    
    <div class="tabs">
      <div class="tab active" data-tab="journal">My Journal</div>
      <div class="tab" data-tab="members">Class Members</div>
      <div class="tab" data-tab="allJournals" style="display: none;">All Student Journals</div>
    </div>
    
    <div id="journalTab" class="tab-content active">
      <div class="tab-header" style="display: flex; justify-content: space-between; margin-bottom: 20px;">
        <h2>My Journal Entries for This Class</h2>
        <button id="addEntryBtn" class="button add-btn">Add New Entry</button>
      </div>
      <p style="margin-bottom: 15px; color: #666;">These are your personal journal entries for this class. Only you can see them.</p>
      
      <div id="journalEntriesContainer" class="journal-grid">
        <div id="emptyJournal" class="empty-state">
          You haven't added any journal entries to this class yet.
        </div>
        <!-- Journal entries will be loaded dynamically -->
      </div>
    </div>
    
    <div id="allJournalsTab" class="tab-content">
      <div class="tab-header" style="margin-bottom: 20px;">
        <h2>All Student Journal Entries</h2>
      </div>
      <p style="margin-bottom: 15px; color: #666;">As a teacher, you can view all student journal entries for this class.</p>
      
      <div style="margin-bottom: 20px;">
        <label for="studentFilter" style="margin-right: 10px;">Filter by Student:</label>
        <select id="studentFilter" style="padding: 8px; border-radius: 4px; border: 1px solid #ddd;">
          <option value="all">All Students</option>
          <!-- Student options will be loaded dynamically -->
        </select>
      </div>
      
      <div id="allJournalEntriesContainer" class="journal-grid">
        <div id="emptyAllJournals" class="empty-state">
          No journal entries found for this class.
        </div>
        <!-- All journal entries will be loaded dynamically -->
      </div>
    </div>
    
    <div id="membersTab" class="tab-content">
      <h2>Class Members</h2>
      <ul id="membersList" class="member-list">
        <div id="emptyMembers" class="empty-state">
          Loading class members...
        </div>
        <!-- Members will be loaded dynamically -->
      </ul>
      
      <div id="adminControls" class="admin-controls">
        <h3>Admin Controls</h3>
        <button id="editClassBtn" class="button admin-btn">Edit Class Details</button>
        <button id="manageRolesBtn" class="button admin-btn" style="margin-left: 10px;">Manage Member Roles</button>
      </div>
    </div>
  </div>
  
  <!-- Edit Class Modal -->
  <div id="editClassModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Edit Class Details</h2>
        <button class="close-btn" id="closeEditModal">&times;</button>
      </div>
      <div class="modal-body">
        <div class="form-group">
          <label for="editClassName">Class Name</label>
          <input type="text" id="editClassName" placeholder="Enter class name" required>
          <div id="nameError" class="error-text">Please enter a valid class name</div>
        </div>
        <div class="form-group">
          <label for="editClassDescription">Description</label>
          <textarea id="editClassDescription" placeholder="Enter class description"></textarea>
        </div>
        <div class="form-group">
          <label for="editClassCode">Class Code</label>
          <div style="display: flex;">
            <input type="text" id="editClassCode" placeholder="Class code" readonly style="flex-grow: 1;">
            <button id="generateNewCodeBtn" class="button" style="margin-left: 10px; background-color: #607d8b;">Generate New</button>
          </div>
          <div id="codeError" class="error-text">This code already exists</div>
        </div>
      </div>
      <div class="modal-footer">
        <button id="cancelEditBtn" class="button cancel-btn">Cancel</button>
        <button id="saveClassChangesBtn" class="button save-btn">Save Changes</button>
      </div>
    </div>
  </div>
  
  <!-- Manage Roles Modal -->
  <div id="manageRolesModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Manage Member Roles</h2>
        <button class="close-btn" id="closeRolesModal">&times;</button>
      </div>
      <div class="modal-body">
        <p>Set roles for class members below:</p>
        <div id="rolesMembersList" style="max-height: 400px; overflow-y: auto; margin-top: 15px;">
          <!-- Members will be loaded here with role selectors -->
        </div>
      </div>
      <div class="modal-footer">
        <button id="cancelRolesBtn" class="button cancel-btn">Cancel</button>
        <button id="saveRolesBtn" class="button save-btn">Save Changes</button>
      </div>
    </div>
  </div>
  
  <script>
    // Initialize Supabase client
    const supabaseClient = supabase.createClient(
      'https://xtwamtfxirypcxszldow.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inh0d2FtdGZ4aXJ5cGN4c3psZG93Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDA0NTIwMzQsImV4cCI6MjA1NjAyODAzNH0.ZZRtoHPlie0FN5IAF1WVd4sRqWOWH_ZfP149Gorit1c'
    );
    
    // Get class ID from URL
    const urlParams = new URLSearchParams(window.location.search);
    const classId = urlParams.get('id');
    let currentUsername = '';
    let userRole = 'student';
    let classData = null;
    
    document.addEventListener('DOMContentLoaded', async () => {
      // Check if user is logged in
      if (localStorage.getItem('musicUserLoggedIn') !== 'true') {
        window.location.href = 'login.html';
        return;
      }
      
      currentUsername = localStorage.getItem('musicUsername');
      
      // Check if class ID is provided
      if (!classId) {
        alert('No class ID provided. Redirecting to dashboard.');
        window.location.href = 'dashboard.html';
        return;
      }
      
      // Initialize tabs
      initTabs();
      
      // Load class data
      await loadClassData();
      
      // Load user's role in this class
      await checkUserRole();
      
      // Load class journal entries
      await loadJournalEntries();
      
      // Load class members
      await loadClassMembers();
      
      // Setup event listeners
      setupEventListeners();
      
      // Set up student filter if teacher/admin
      const globalRole = localStorage.getItem('musicUserRole');
      if (userRole === 'admin' || globalRole === 'teacher' || globalRole === 'admin') {
        setupStudentFilter();
      }
      
      // Initialize background slider
      initBackgroundSlider();
    });
    
    // Initialize tabs
    function initTabs() {
      const tabs = document.querySelectorAll('.tab');
      const tabContents = document.querySelectorAll('.tab-content');
      
      tabs.forEach(tab => {
        tab.addEventListener('click', () => {
          // Remove active class from all tabs and contents
          tabs.forEach(t => t.classList.remove('active'));
          tabContents.forEach(c => c.classList.remove('active'));
          
          // Add active class to clicked tab
          tab.classList.add('active');
          
          // Show corresponding content
          const tabId = tab.getAttribute('data-tab');
          document.getElementById(`${tabId}Tab`).classList.add('active');
        });
      });
    }
    
    // Load class data
    async function loadClassData() {
      try {
        const { data: classroom, error } = await supabaseClient
          .from('classrooms')
          .select('*')
          .eq('id', classId)
          .single();
          
        if (error || !classroom) {
          console.error('Error loading class data:', error);
          alert('Failed to load class. Redirecting to dashboard.');
          window.location.href = 'dashboard.html';
          return;
        }
        
        classData = classroom;
        
        // Update UI with class data
        document.getElementById('className').textContent = classroom.class_name;
        document.getElementById('classDescription').textContent = classroom.description || 'No description available.';
        document.getElementById('classCode').textContent = `Code: ${classroom.class_code}`;
        document.getElementById('createdBy').textContent = `Created by: ${classroom.created_by}`;
        
        // Update page title
        document.title = `${classroom.class_name} - Music Journal`;
      } catch (err) {
        console.error('Error in loadClassData:', err);
        alert('An unexpected error occurred. Redirecting to dashboard.');
        window.location.href = 'dashboard.html';
      }
    }
    
    // Check user's role in this class
    async function checkUserRole() {
      try {
        const { data: membership, error } = await supabaseClient
          .from('class_memberships')
          .select('role')
          .eq('username', currentUsername)
          .eq('class_id', classId)
          .single();
          
        if (error) {
          console.error('Error checking user role:', error);
          return;
        }
        
        userRole = membership.role || 'student';
        
        // Also get global user role (teacher/admin/student)
        const { data: profile, profileError } = await supabaseClient
          .from('profiles')
          .select('role')
          .eq('username', currentUsername)
          .single();
          
        const globalRole = profile?.role || 'student';
        console.log('User global role:', globalRole, 'Class role:', userRole);
        
        // Show admin controls if user is admin in this class or a teacher/admin globally
        if (userRole === 'admin' || globalRole === 'teacher' || globalRole === 'admin') {
          document.getElementById('adminControls').style.display = 'block';
          
          // Show the All Journals tab for teachers and admins
          document.querySelector('.tab[data-tab="allJournals"]').style.display = 'block';
          
          // If user is a teacher or admin, load all journal entries
          await loadAllJournalEntries();
        }
      } catch (err) {
        console.error('Error in checkUserRole:', err);
      }
    }
    
    // Load personal journal entries for this class
    async function loadJournalEntries() {
      try {
        // Get current username
        const username = localStorage.getItem('musicUsername');
        if (!username) {
          console.error('User not logged in');
          return;
        }
        
        // Get only this user's entries for this class
        const { data: entries, error } = await supabaseClient
          .from('journal_entries')
          .select('*')
          .eq('username', username)
          .eq('class_id', classId)
          .order('created_at', { ascending: false });
          
        if (error) {
          console.error('Error loading journal entries:', error);
          return;
        }
        
        const entriesContainer = document.getElementById('journalEntriesContainer');
        const emptyState = document.getElementById('emptyJournal');
        
        if (!entries || entries.length === 0) {
          emptyState.textContent = 'You haven\'t added any journal entries to this class yet.';
          emptyState.style.display = 'block';
          return;
        }
        
        emptyState.style.display = 'none';
        
        // Clear any existing entries
        entriesContainer.innerHTML = '';
        
        // Create cards for each entry
        entries.forEach(entry => {
          const card = document.createElement('div');
          card.className = 'journal-card';
          
          // Format date
          const createdDate = new Date(entry.created_at).toLocaleDateString();
          
          card.innerHTML = `
            <h3 class="journal-title">${entry.title}</h3>
            <p>Type: ${entry.entry_type || 'N/A'}</p>
            <div class="journal-meta">
              <span>By: ${entry.username}</span>
              <span>Added: ${createdDate}</span>
            </div>
          `;
          
          // Add click handler to open the entry
          card.addEventListener('click', () => {
            if (entry.link) {
              window.open(entry.link, '_blank');
            }
          });
          
          entriesContainer.appendChild(card);
        });
      } catch (err) {
        console.error('Error in loadJournalEntries:', err);
      }
    }
    
    // Load class members
    async function loadClassMembers() {
      try {
        const { data: members, error } = await supabaseClient
          .from('class_memberships')
          .select('username, role, joined_at')
          .eq('class_id', classId)
          .order('role', { ascending: false });
          
        if (error) {
          console.error('Error loading class members:', error);
          return;
        }
        
        const membersList = document.getElementById('membersList');
        const emptyState = document.getElementById('emptyMembers');
        
        if (!members || members.length === 0) {
          emptyState.textContent = 'No members found in this class.';
          return;
        }
        
        // Hide empty state
        emptyState.style.display = 'none';
        
        // Clear existing members
        membersList.innerHTML = '';
        
        // Get global role to determine if viewing journals is allowed
        const globalRole = localStorage.getItem('musicUserRole');
        const canViewStudentJournals = (userRole === 'admin' || globalRole === 'teacher' || globalRole === 'admin');
        
        // Create list items for each member
        members.forEach(member => {
          const item = document.createElement('li');
          item.className = 'member-item';
          
          // Format join date
          const joinDate = new Date(member.joined_at).toLocaleDateString();
          
          // Create the username element - make it clickable for teachers/admins
          let usernameHtml = '';
          if (canViewStudentJournals && member.username !== currentUsername) {
            usernameHtml = `<strong class="student-name-link" data-username="${member.username}">${member.username}</strong>`;
          } else {
            usernameHtml = `<strong>${member.username}</strong>`;
          }
          
          item.innerHTML = `
            <div>
              ${usernameHtml}
              <div style="font-size: 0.8rem; color: #757575;">Joined: ${joinDate}</div>
            </div>
            <span class="member-role ${member.role === 'admin' ? 'admin' : ''}">${
              member.role.charAt(0).toUpperCase() + member.role.slice(1)
            }</span>
          `;
          
          membersList.appendChild(item);
        });
        
        // Add click handlers for student names
        if (canViewStudentJournals) {
          document.querySelectorAll('.student-name-link').forEach(link => {
            link.style.cursor = 'pointer';
            link.style.color = '#2196F3';
            link.title = 'Click to view this student\'s journal';
            
            link.addEventListener('click', () => {
              const studentUsername = link.getAttribute('data-username');
              viewStudentJournal(studentUsername);
            });
          });
        }
      } catch (err) {
        console.error('Error in loadClassMembers:', err);
      }
    }
    
    // View a specific student's journal
    async function viewStudentJournal(username) {
      try {
        console.log(`Viewing journal for student: ${username}`);
        
        // Get the student's journal entries
        const { data: entries, error } = await supabaseClient
          .from('journal_entries')
          .select('*')
          .eq('username', username)
          .eq('class_id', classId)
          .order('created_at', { ascending: false });
          
        if (error) {
          console.error(`Error loading journal entries for ${username}:`, error);
          alert(`Could not load journal entries for ${username}. Please try again.`);
          return;
        }
        
        // Create a modal to display the student's journal
        const modalHtml = `
          <div id="studentJournalModal" class="modal active">
            <div class="modal-content" style="width: 90%; max-width: 800px;">
              <div class="modal-header">
                <h2>${username}'s Journal Entries</h2>
                <button class="close-btn" id="closeStudentJournalModal">&times;</button>
              </div>
              <div class="modal-body">
                <p>Viewing journal entries for ${username} in this class.</p>
                <div id="studentJournalEntries" class="journal-grid" style="margin-top: 20px;">
                  ${entries && entries.length > 0 ? '' : `<div class="empty-state">No journal entries found for ${username} in this class.</div>`}
                </div>
              </div>
              <div class="modal-footer">
                <button id="closeStudentJournalBtn" class="button cancel-btn">Close</button>
              </div>
            </div>
          </div>
        `;
        
        // Add the modal to the page
        document.body.insertAdjacentHTML('beforeend', modalHtml);
        
        // Add event listeners for closing the modal
        document.getElementById('closeStudentJournalModal').addEventListener('click', () => {
          document.getElementById('studentJournalModal').remove();
        });
        
        document.getElementById('closeStudentJournalBtn').addEventListener('click', () => {
          document.getElementById('studentJournalModal').remove();
        });
        
        // If there are entries, add them to the modal
        if (entries && entries.length > 0) {
          const container = document.getElementById('studentJournalEntries');
          
          entries.forEach(entry => {
            const card = document.createElement('div');
            card.className = 'journal-card';
            
            // Format date
            const createdDate = new Date(entry.created_at).toLocaleDateString();
            
            // Add content or preview based on entry type
            let contentPreview = '';
            if (entry.content) {
              // Show a snippet of content if available
              contentPreview = `<p class="preview-text">${entry.content.substring(0, 100)}${entry.content.length > 100 ? '...' : ''}</p>`;
            } else if (entry.link) {
              contentPreview = `<p class="preview-text">External link: ${entry.link}</p>`;
            }
            
            card.innerHTML = `
              <h3 class="journal-title">${entry.title}</h3>
              <p>Type: ${entry.entry_type || 'N/A'}</p>
              ${contentPreview}
              <div class="journal-meta">
                <span>Added: ${createdDate}</span>
              </div>
            `;
            
            // Style the card
            card.style.borderLeft = `5px solid ${stringToColor(username)}`;
            
            // Add click handler to open the entry
            card.addEventListener('click', () => {
              if (entry.link) {
                window.open(entry.link, '_blank');
              }
            });
            
            container.appendChild(card);
          });
        }
      } catch (err) {
        console.error(`Error in viewStudentJournal for ${username}:`, err);
        alert('An unexpected error occurred. Please try again.');
      }
    }
    
    // Initialize background slider animation
    function initBackgroundSlider() {
      const images = document.querySelectorAll('.slider-img');
      if (images.length === 0) return;
      
      const directions = ['slide-left', 'slide-right', 'slide-top', 'slide-bottom'];
      let currentImageIndex = 0;
      
      function animateNextImage() {
        // Remove animation from all images
        images.forEach(img => {
          img.classList.remove(...directions);
          img.style.opacity = 0;
        });
        
        // Get the next direction randomly
        const direction = directions[Math.floor(Math.random() * directions.length)];
        
        // Show and animate next image
        const img = images[currentImageIndex];
        img.classList.add(direction);
        
        // Move to next image, loop back to start if at the end
        currentImageIndex = (currentImageIndex + 1) % images.length;
        
        // Wait for animation to finish, then do the next one
        setTimeout(animateNextImage, 10000); // 10 seconds
      }
      
      // Start animation sequence
      console.log('Starting background animation');
      animateNextImage();
    }
    
    // Setup event listeners
    function setupEventListeners() {
      // Back button
      document.getElementById('backBtn').addEventListener('click', () => {
        window.location.href = 'dashboard.html';
      });
      
      // Add entry button
      document.getElementById('addEntryBtn').addEventListener('click', () => {
        window.location.href = `journal.html?class_id=${classId}&class_name=${encodeURIComponent(classData.class_name)}`;
      });
      
      // Admin buttons (if shown)
      const editClassBtn = document.getElementById('editClassBtn');
      if (editClassBtn) {
        editClassBtn.addEventListener('click', () => {
          showEditClassModal();
        });
      }
      
      const manageRolesBtn = document.getElementById('manageRolesBtn');
      if (manageRolesBtn) {
        manageRolesBtn.addEventListener('click', () => {
          showManageRolesModal();
        });
      }
      
      // Edit class modal events
      document.getElementById('closeEditModal').addEventListener('click', () => {
        document.getElementById('editClassModal').classList.remove('active');
      });
      
      document.getElementById('cancelEditBtn').addEventListener('click', () => {
        document.getElementById('editClassModal').classList.remove('active');
      });
      
      document.getElementById('generateNewCodeBtn').addEventListener('click', () => {
        generateRandomClassCode();
      });
      
      document.getElementById('saveClassChangesBtn').addEventListener('click', async () => {
        await saveClassChanges();
      });
      
      // Manage roles modal events
      document.getElementById('closeRolesModal').addEventListener('click', () => {
        document.getElementById('manageRolesModal').classList.remove('active');
      });
      
      document.getElementById('cancelRolesBtn').addEventListener('click', () => {
        document.getElementById('manageRolesModal').classList.remove('active');
      });
      
      document.getElementById('saveRolesBtn').addEventListener('click', async () => {
        await saveRoleChanges();
      });
    }
    
    // Show edit class modal and populate with current data
    function showEditClassModal() {
      // Set current values in the form
      document.getElementById('editClassName').value = classData.class_name;
      document.getElementById('editClassDescription').value = classData.description || '';
      document.getElementById('editClassCode').value = classData.class_code;
      
      // Clear any error messages
      document.getElementById('nameError').style.display = 'none';
      document.getElementById('codeError').style.display = 'none';
      
      // Show the modal
      document.getElementById('editClassModal').classList.add('active');
    }
    
    // Generate a random class code
    function generateRandomClassCode() {
      const characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
      let result = '';
      const length = 6;
      
      for (let i = 0; i < length; i++) {
        result += characters.charAt(Math.floor(Math.random() * characters.length));
      }
      
      document.getElementById('editClassCode').value = result;
      document.getElementById('codeError').style.display = 'none';
    }
    
    // Save class changes
    async function saveClassChanges() {
      const newClassName = document.getElementById('editClassName').value.trim();
      const newDescription = document.getElementById('editClassDescription').value.trim();
      const newClassCode = document.getElementById('editClassCode').value.trim();
      
      // Validate inputs
      let hasError = false;
      
      if (!newClassName) {
        document.getElementById('nameError').style.display = 'block';
        hasError = true;
      } else {
        document.getElementById('nameError').style.display = 'none';
      }
      
      // Only check for code uniqueness if the code has changed
      if (newClassCode !== classData.class_code) {
        try {
          const { data: existingClass, error } = await supabaseClient
            .from('classrooms')
            .select('id')
            .eq('class_code', newClassCode);
            
          if (!error && existingClass && existingClass.length > 0) {
            document.getElementById('codeError').style.display = 'block';
            hasError = true;
          } else {
            document.getElementById('codeError').style.display = 'none';
          }
        } catch (err) {
          console.error('Error checking class code:', err);
          alert('Error checking class code. Please try again.');
          return;
        }
      }
      
      if (hasError) {
        return;
      }
      
      // Update the class in the database
      try {
        const { data, error } = await supabaseClient
          .from('classrooms')
          .update({
            class_name: newClassName,
            description: newDescription,
            class_code: newClassCode
          })
          .eq('id', classId);
          
        if (error) {
          console.error('Error updating class:', error);
          alert('Failed to update class. Please try again.');
          return;
        }
        
        // Update local data
        classData.class_name = newClassName;
        classData.description = newDescription;
        classData.class_code = newClassCode;
        
        // Update UI
        document.getElementById('className').textContent = newClassName;
        document.getElementById('classDescription').textContent = newDescription || 'No description available.';
        document.getElementById('classCode').textContent = `Code: ${newClassCode}`;
        
        // Update page title
        document.title = `${newClassName} - Music Journal`;
        
        // Close the modal
        document.getElementById('editClassModal').classList.remove('active');
        
        alert('Class details updated successfully!');
      } catch (err) {
        console.error('Error in saveClassChanges:', err);
        alert('An unexpected error occurred. Please try again.');
      }
    }
    
    // Show manage roles modal and load members
    async function showManageRolesModal() {
      try {
        // Get all members for this class
        const { data: members, error } = await supabaseClient
          .from('class_memberships')
          .select('username, role')
          .eq('class_id', classId);
          
        if (error) {
          console.error('Error loading members for role management:', error);
          alert('Failed to load class members. Please try again.');
          return;
        }
        
        const membersList = document.getElementById('rolesMembersList');
        membersList.innerHTML = '';
        
        if (!members || members.length === 0) {
          membersList.innerHTML = '<div class="empty-state">No members found in this class.</div>';
        } else {
          // Create UI for each member
          members.forEach(member => {
            const memberItem = document.createElement('div');
            memberItem.className = 'member-role-item';
            memberItem.style.display = 'flex';
            memberItem.style.justifyContent = 'space-between';
            memberItem.style.alignItems = 'center';
            memberItem.style.padding = '10px';
            memberItem.style.borderBottom = '1px solid #eee';
            
            // Create a select dropdown for role
            const roleSelect = document.createElement('select');
            roleSelect.dataset.username = member.username;
            roleSelect.className = 'role-select';
            roleSelect.style.padding = '5px';
            roleSelect.style.borderRadius = '4px';
            
            // Add options
            const studentOption = document.createElement('option');
            studentOption.value = 'student';
            studentOption.textContent = 'Student';
            roleSelect.appendChild(studentOption);
            
            const adminOption = document.createElement('option');
            adminOption.value = 'admin';
            adminOption.textContent = 'Admin';
            roleSelect.appendChild(adminOption);
            
            // Set current role
            roleSelect.value = member.role;
            
            // Create the member item UI
            memberItem.innerHTML = `
              <div style="font-weight: 500;">${member.username}</div>
            `;
            memberItem.appendChild(roleSelect);
            
            membersList.appendChild(memberItem);
          });
        }
        
        // Show the modal
        document.getElementById('manageRolesModal').classList.add('active');
      } catch (err) {
        console.error('Error in showManageRolesModal:', err);
        alert('An unexpected error occurred. Please try again.');
      }
    }
        // Save role changes
    async function saveRoleChanges() {
      try {
        const roleSelects = document.querySelectorAll('.role-select');
        const updates = [];
        
        roleSelects.forEach(select => {
          updates.push({
            username: select.dataset.username,
            role: select.value
          });
        });
        
        // Update each member's role
        for (const update of updates) {
          const { error } = await supabaseClient
            .from('class_memberships')
            .update({ role: update.role })
            .eq('class_id', classId)
            .eq('username', update.username);
            
          if (error) {
            console.error(`Error updating role for ${update.username}:`, error);
          }
        }
        
        // Close the modal
        document.getElementById('manageRolesModal').classList.remove('active');
        
        // Refresh the members list
        await loadClassMembers();
        
        alert('Member roles updated successfully!');
      } catch (err) {
        console.error('Error in saveRoleChanges:', err);
        alert('An unexpected error occurred. Please try again.');
      }
    }
    
    // Load all journal entries for the class (teacher view)
    async function loadAllJournalEntries(filterUsername = 'all') {
      try {
        console.log('Loading all journal entries, filter by:', filterUsername);
        
        // Get all entries for this class, filtered by username if needed
        let query = supabaseClient
          .from('journal_entries')
          .select('*')
          .eq('class_id', classId)
          .order('created_at', { ascending: false });
          
        // Apply username filter if not 'all'
        if (filterUsername !== 'all') {
          query = query.eq('username', filterUsername);
        }
        
        const { data: entries, error } = await query;
          
        if (error) {
          console.error('Error loading all journal entries:', error);
          return;
        }
        
        console.log('Retrieved entries:', entries?.length || 0);
        
        const entriesContainer = document.getElementById('allJournalEntriesContainer');
        const emptyState = document.getElementById('emptyAllJournals');
        
        if (!entries || entries.length === 0) {
          emptyState.textContent = filterUsername === 'all' 
            ? 'No journal entries found for this class.'
            : `No journal entries found for student ${filterUsername}.`;
          emptyState.style.display = 'block';
          entriesContainer.innerHTML = '';
          return;
        }
        
        emptyState.style.display = 'none';
        
        // Clear any existing entries
        entriesContainer.innerHTML = '';
        
        // Create cards for each entry
        entries.forEach(entry => {
          const card = document.createElement('div');
          card.className = 'journal-card';
          
          // Format date
          const createdDate = new Date(entry.created_at).toLocaleDateString();
          
          // Add content or preview based on entry type
          let contentPreview = '';
          if (entry.content) {
            // Show a snippet of content if available
            contentPreview = `<p class="preview-text">${entry.content.substring(0, 100)}${entry.content.length > 100 ? '...' : ''}</p>`;
          } else if (entry.link) {
            contentPreview = `<p class="preview-text">External link: ${entry.link}</p>`;
          }
          
          card.innerHTML = `
            <h3 class="journal-title">${entry.title}</h3>
            <p>Type: ${entry.entry_type || 'N/A'}</p>
            ${contentPreview}
            <div class="journal-meta">
              <span>By: <strong class="student-name-link" data-username="${entry.username}">${entry.username}</strong></span>
              <span>Added: ${createdDate}</span>
            </div>
          `;
          
          // Style the card with a border color based on username
          card.style.borderLeft = `5px solid ${stringToColor(entry.username)}`;
          
          // Add click handler to open the entry content when clicking on the card
          card.addEventListener('click', (e) => {
            // Don't handle card click if they clicked on the student name
            if (!e.target.classList.contains('student-name-link')) {
              if (entry.link) {
                window.open(entry.link, '_blank');
              }
            }
          });
          
          entriesContainer.appendChild(card);
        });
        
        // Add click handlers for student names in entries
        document.querySelectorAll('#allJournalEntriesContainer .student-name-link').forEach(link => {
          link.style.cursor = 'pointer';
          link.style.color = '#2196F3';
          link.title = 'Click to view this student\'s journal';
          
          link.addEventListener('click', (e) => {
            e.stopPropagation(); // Prevent the card click event from firing
            const studentUsername = link.getAttribute('data-username');
            viewStudentJournal(studentUsername);
          });
        });
      } catch (err) {
        console.error('Error in loadAllJournalEntries:', err);
      }
    }
    
    // Helper function to generate a color from a string (username)
    function stringToColor(str) {
      let hash = 0;
      for (let i = 0; i < str.length; i++) {
        hash = str.charCodeAt(i) + ((hash << 5) - hash);
      }
      let color = '#';
      for (let i = 0; i < 3; i++) {
        const value = (hash >> (i * 8)) & 0xFF;
        color += ('00' + value.toString(16)).substr(-2);
      }
      return color;
    }
    
    // Setup student filter dropdown
    async function setupStudentFilter() {
      try {
        // Get all members for this class
        const { data: members, error } = await supabaseClient
          .from('class_memberships')
          .select('username')
          .eq('class_id', classId);
          
        if (error) {
          console.error('Error loading members for filter:', error);
          return;
        }
        
        const studentFilter = document.getElementById('studentFilter');
        
        // Clear existing options except the 'All Students' option
        while (studentFilter.options.length > 1) {
          studentFilter.remove(1);
        }
        
        // Add each member as an option
        members.forEach(member => {
          const option = document.createElement('option');
          option.value = member.username;
          option.textContent = member.username;
          studentFilter.appendChild(option);
        });
        
        // Add change event listener
        studentFilter.addEventListener('change', event => {
          loadAllJournalEntries(event.target.value);
        });
      } catch (err) {
        console.error('Error in setupStudentFilter:', err);
      }
    }
  </script>
</body>
</html>
